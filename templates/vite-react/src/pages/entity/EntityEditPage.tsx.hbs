/**
 * {{entity.name}} Edit Page
 * Generated by Dashboard Generator
 */

import { useState, useEffect } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { PageHeader } from '@/components/layout';
import { Card, CardContent, LoadingState } from '@/components/ui';
import { FormField, FormSection, FormActions } from '@/components/forms';
import { use{{entity.name}}, use{{entity.name}}Mutations } from '@/hooks/use{{entity.pluralName}}';
import type { Update{{entity.name}}Dto } from '@/types';

export function {{entity.name}}EditPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();

  const { {{camelCase entity.name}}, isLoading: isLoadingData, isError, error: loadError } = use{{entity.name}}(id);
  const { update{{entity.name}}, isLoading: isUpdating, error: updateError } = use{{entity.name}}Mutations();

  const [formData, setFormData] = useState<Update{{entity.name}}Dto>({});
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [initialized, setInitialized] = useState(false);

  // Initialize form with existing data
  useEffect(() => {
    if ({{camelCase entity.name}} && !initialized) {
      setFormData({
{{#each entity.fields}}
{{#if showInForm}}
        {{name}}: {{camelCase ../entity.name}}.{{name}},
{{/if}}
{{/each}}
      });
      setInitialized(true);
    }
  }, [{{camelCase entity.name}}, initialized]);

  const handleFieldChange = (name: string, value: unknown) => {
    setFormData((prev) => ({ ...prev, [name]: value }));
    if (errors[name]) {
      setErrors((prev) => {
        const newErrors = { ...prev };
        delete newErrors[name];
        return newErrors;
      });
    }
  };

  const validate = (): boolean => {
    const newErrors: Record<string, string> = {};

{{#each entity.fields}}
{{#if showInForm}}
{{#if required}}
    if (!formData.{{name}}{{#if (eq type "string")}} || String(formData.{{name}}).trim() === ''{{/if}}{{#if (eq type "text")}} || String(formData.{{name}}).trim() === ''{{/if}}) {
      newErrors.{{name}} = '{{label}} is required';
    }
{{/if}}
{{#if minLength}}
    if (formData.{{name}} && String(formData.{{name}}).length < {{minLength}}) {
      newErrors.{{name}} = '{{label}} must be at least {{minLength}} characters';
    }
{{/if}}
{{#if maxLength}}
    if (formData.{{name}} && String(formData.{{name}}).length > {{maxLength}}) {
      newErrors.{{name}} = '{{label}} must be no more than {{maxLength}} characters';
    }
{{/if}}
{{#if min}}
    if (formData.{{name}} !== undefined && Number(formData.{{name}}) < {{min}}) {
      newErrors.{{name}} = '{{label}} must be at least {{min}}';
    }
{{/if}}
{{#if max}}
    if (formData.{{name}} !== undefined && Number(formData.{{name}}) > {{max}}) {
      newErrors.{{name}} = '{{label}} must be no more than {{max}}';
    }
{{/if}}
{{/if}}
{{/each}}

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!id || !validate()) return;

    const result = await update{{entity.name}}(id, formData);
    if (result) {
      navigate(`/{{entity.slug}}/${id}`);
    }
  };

  if (isLoadingData) {
    return <LoadingState message="Loading {{lowerCase entity.name}}..." />;
  }

  if (isError || !{{camelCase entity.name}}) {
    return (
      <div className="text-center py-12">
        <p className="text-red-600">{loadError || '{{entity.name}} not found'}</p>
        <Link to="/{{entity.slug}}" className="text-primary-600 hover:underline mt-2 inline-block">
          Back to {{entity.pluralName}}
        </Link>
      </div>
    );
  }

  return (
    <div>
      <PageHeader
        title={`Edit ${ {{camelCase entity.name}}.name || '{{entity.name}}'}`}
        breadcrumbs={[
          { label: 'Dashboard', href: '/' },
          { label: '{{entity.pluralName}}', href: '/{{entity.slug}}' },
          { label: {{camelCase entity.name}}.name || '{{entity.name}}', href: `/{{entity.slug}}/$\{id}` },
          { label: 'Edit' },
        ]}
      />

      <Card>
        <CardContent>
          <form onSubmit={handleSubmit}>
            {updateError && (
              <div className="mb-6 p-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg">
                {updateError}
              </div>
            )}

            <FormSection columns={2}>
{{#each entity.fields}}
{{#if showInForm}}
              <FormField
                name="{{name}}"
                label="{{label}}"
                type="{{type}}"
                value={formData.{{name}} ?? ''}
                onChange={handleFieldChange}
                error={errors.{{name}} }
                required={ {{required}} }
{{#if (eq type "enum")}}
                options={[
{{#each enumValues}}
                  { value: '{{this}}', label: '{{this}}' },
{{/each}}
                ]}
{{/if}}
{{#if min}}
                min={ {{min}} }
{{/if}}
{{#if max}}
                max={ {{max}} }
{{/if}}
{{#if minLength}}
                minLength={ {{minLength}} }
{{/if}}
{{#if maxLength}}
                maxLength={ {{maxLength}} }
{{/if}}
              />
{{/if}}
{{/each}}
            </FormSection>

            <FormActions
              submitLabel="Save Changes"
              cancelHref={`/{{entity.slug}}/${id}`}
              isLoading={isUpdating}
            />
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
